
# **SMTP与POP3,IMAP: 邮件服务**

## **邮件系统的组成结构**

电子邮件是一种**异步通信方式**，通信时不需要双方同时在场，发送者把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可以随时上网到自己使用的邮件服务器进行读取

### **Email的构成组件**

```mermaid
graph LR
    %% 定义节点
    Sender(发送方<br>用户代理)
    SinaServer[新浪邮件服务器<br>邮件缓存]
    NetEaseServer[网易邮件服务器<br>用户邮箱]
    Receiver(接收方<br>用户代理)

    %% 定义流程和协议
    Sender -- "HTTP<br>(发送邮件)" --> SinaServer
    SinaServer -- "SMTP<br>(因特网传输)" --> NetEaseServer
    NetEaseServer -- "HTTP<br>(读取邮件)" --> Receiver

    %% 样式定义 (可选，为了更好看)
    style SinaServer fill:#f9f,stroke:#333,stroke-width:2px
    style NetEaseServer fill:#f9f,stroke:#333,stroke-width:2px
```

## **SMTP：简单邮件传输协议**

用于发送邮件，它使用TCP**可靠传输服务**,SMTP采用的是**“推”(Push)**的通信方式，即在用户代理向邮件服务器发送邮件及在邮件服务器之间发送邮件时，**SMTP客户端主动将邮件“推”送到SMTP服务器端**

### **通讯过程**

运行**SMTP客户进程**，具体显示为**C**，运行**SMTP服务器进程**，具体显示为**S**

### **1.建立通讯**

```bash
S：220 hamburger.edu

C：HELO crepes.fr

S：250 Hello crepes.fr, pleased to meet you .
```

发件人的邮件发送到发送方邮件服务器的邮件缓存中后，SMTP客户就每隔一定 时间对邮件缓存扫描一次，如发现有邮件，就使用SMTP的端口号(25) 与接收方邮件服务器的SMTP服务器建立TCP连接

连接建立后，接收方SMTP服务器发出220 Service ready (服务就绪)，然后SMTP客户向SMTP服务器发送HELO命令，附上发送方的主机名

### **2，邮件传送**

```bash
C:MAIL FROM: <alice@crepes.fr>

S：250 alice@crepes.fr... Sender ok

C：RCPT TO: <bob@hamburger.edu>

S：250 bob@hamburger.edu ... Recipient ok

C：DATA

S： 354 Enter mail, end with "." on a line by itself C:Do you like ketchup?

C:How about pickles?

C: .

S:250 Message accepted for delivery
```

连接建立后，就可开始传送邮件, 邮件的传送从MAIL命令开始，MAIL 命令后面有发件人的地址

若SMTP服务器已准备好接收邮件，则回答250 OK

然后SMTP客户端发送一个或多个RCPT命令，格式为RCPTTO: <收件人地址>，每发送一个 RCPT命令，都有相应的信息从SMTP服务器返回，如250 OK或550 No such user here (无此用户)

RCPT命令的作用是：了解接收方系统是否已做好接收邮件的准备，然后才发送邮件，以便不至于发送了很长的邮件后才知道地址错误，进而避免浪费通信资源，

获得0K的回答后，客户端就使用DATA命令，表示要开始传输邮件的内容，正常情况下，SMTP服务器回复信息是354 Enter mail , end with “.” …，此时SMTP客户端就可开始传送邮件内容，后面语句表示邮件内容的结束

### **3，连接释放**

```bash
C: QUIT

S：221 hamburger.edu closing connection
```

邮件发送完毕后，SMTP客户应发送QUIT命令SMTP服务器返回的信息是221 (服务关闭)，表示SMTP同意释放TCP连接, 邮件传送的全部过程就此结束

```bash
c:telent SMTP.163.com25 #以telenet方式连按163邮件服务器
S:220163.com Anti-spamGTfor CoremailSystem #220为响应数字，其后的为欢迎信息
C:HEL0SMTP.163.COm #除了HELO所具有的功能外，EHLO主要用来查询服务器支持的扩充功能
S:250-mail
S: 250-AUTH LOGIN PLAIN
S:250-AUTH=LOGIN PLAIN
S:250 8BITMIME #最后一个响应数字应答码之后跟的是一个空格，而不是'_'。
C:AUTH LOGIN #请求认证
S:334 dxNlcm5hbwU6 #服务器的响应——经过base64编码了的“Username"=
C:Y29zdGFAYW1heGLOLm5ldA==： #发送经过BASE64编码了的用户名
S:334 UGFzc3dvcmQ6 #经过BASE64编码了的" Password:"=
C:1MTk4MJIXNA== #客户端发送的经过BASE64编码了的密码
S:235 auth successfully #认证成功
C:MAILFROM:bripengandre@163.com #发送者邮箱
S:250 _ . #'_'代表省略了一些可读信息
C:RCPTTO:bripengandre@smail.hust.edu.cn #按收者邮箱
S:250 _ . #“_“代表省略了一些可读信息
C：DATA//请求发送数据
S:354 Enter mail, end with "." on a line by itself
C: Enjoy Protocol Studing
C: . 
S: 250 Message sent
C:QUIT #退出连按
S:221 Bye
```

### **代码**

在命令成功时，服务器返回代码**250**，如果失败则返回代码**550**（命令无法识别）、**451**（处理时出错）、**452**（存储空间不够）、**421**（服务器不可用）等，**354**则表示开始信息输入

其他命令[邮件协议讲解（SMTP、POP3、IMAP）_imap/pop3/smtp服务。-CSDN博客](https://blog.csdn.net/m0_49864110/article/details/134819771)

### **SMTP与HTTP的不同（待扩张）**

![图片无法显示](应用层_image/image3.png)

- **HTTP**主要是一个**拉协议**, 即某些人在Web服务器上装载信息，用户使用HTTP从该服务器拉取这些信息。特别是**TCP连接是由想接收文件的机器发起的**。
- **SMTP** 基本上是一个**推协议**，即发送邮件服务器把文件推向接收邮件服务器。这个**TCP连接是由要发送该文件的机器发起的**。
- HTTP把每个对象封装到单独的HTTP响应报文中。而SMTP则把所有消息对象放在一个报文之中。

```bash
c:telent SMTP.163.com25 #以telenet方式连按163邮件服务器
S:220163.com Anti-spamGTfor CoremailSystem #220为响应数字，其后的为欢迎信息
C:HEL0SMTP.163.COm #除了HELO所具有的功能外，EHLO主要用来查询服务器支持的扩充功能
S:250-mail
S: 250-AUTH LOGIN PLAIN
S:250-AUTH=LOGIN PLAIN
S:250 8BITMIME #最后一个响应数字应答码之后跟的是一个空格，而不是'_'。
C:AUTH LOGIN #请求认证
S:334 dxNlcm5hbwU6 #服务器的响应——经过base64编码了的“Username"=
C:Y29zdGFAYW1heGLOLm5ldA==： #发送经过BASE64编码了的用户名
S:334 UGFzc3dvcmQ6 #经过BASE64编码了的" Password:"=
C:1MTk4MJIXNA== #客户端发送的经过BASE64编码了的密码
S:235 auth successfully #认证成功
C:MAILFROM:bripengandre@163.com #发送者邮箱
S:250 _ . #'_'代表省略了一些可读信息
C:RCPTTO:bripengandre@smail.hust.edu.cn #按收者邮箱
S:250 _ . #“_“代表省略了一些可读信息
C：DATA//请求发送数据
S:354 Enter mail, end with "." on a line by itself
C: Enjoy Protocol Studing
C: . 
S: 250 Message sent
C:QUIT #退出连按
S:221 Bye
```

## **POP3: 邮局协议版本3**

用于**接收邮件**，采用的是**“拉”(Pull)**的通信方式，当用户读取邮件时，**用户代理向邮件服务器发出请求，“拉”取用户邮箱中的邮件**, 首先要进行认证，然后才可以进入事务阶段，进行获取邮件

POP有两种工作方式:

- **下载并保留**
- **下载并删除**
  
```bash
# 认证过程
#user:申明用户
##pass：声明密码
S: +OK POP3 server ready
C: user bob
S:+OK
C: pass hungry
S:+OK user successfully logged on

#事物阶段
#list:列出消息数量
#retr：用编号获取消息
#dele：删除消息
#quit退出
C:list
S:1 498
S:2 912
S:.
C:dele 1
C:retr 2
S:<message 1 contents>
S:.
C: dele 1
C: retr 2
S: <message 1 contents>
S:.
C:dele 2
Quit
C: quit
S: +OK PoP3 server signing cfEN @Paranoida
```

## **IMAP互联网邮件访问协议**

它比POP复杂得多，IMAP为用户提供了**创建文件夹**、**在不同文件夹之间移动邮件**及在**远程文件夹中查询邮件的命令**，为此IMAP服务器维护了会话用户的状态信息

- 所有消息统一保存在一个地方：服务器
- 允许用户利用文件夹组织消息
- IMAP支持跨会话(Session)的用户状态:文件夹的名字文件夹与消息ID之间的映射等
- IMAP允许用户代理只获取报文的某些部分，例如可以只读取一个报文的首部,或一个多部分MIME报文的一部分。

## **POP3与IMAP区别**

|  操作位置 | 操作内容 | IMAP | POP3 |
| --- | --- | --- | --- |
| 收件箱 | 阅读、标记、移动、删除邮件等 | 客户端与邮箱更新同步 | 仅客户端内 |
| 发件箱 | 保存到已发送 | 客户端与邮箱更新同步 | 仅客户端内 |
| 创建文件夹 | 新建自定义的文件夹 | 客户端与邮箱更新同步 | 仅客户端内 |
| 草稿 | 保存草稿 | 客户端与邮箱更新同步 | 仅客户端内 |
| 垃圾文件夹 | 接收误移入垃圾文件夹的邮件 | 支持 | 不支持 |
| 广告邮件 | 接收被移入广告邮件夹的邮件 | 支持 | 不支持 |
